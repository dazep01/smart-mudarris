<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Mudarris - Login & Signup</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
:root {
    --primary: #4361ee;
    --primary-light: #4895ef;
    --primary-dark: #3a0ca3;
    --secondary: #7209b7;
    --success: #4cc9f0;
    --danger: #f72585;
    --warning: #ff9e00;
    --dark: #212529;
    --light: #f8f9fa;
    --gray: #6c757d;
    --gray-light: #e9ecef;
    --border-radius: 16px;
    --box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    --box-shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.15);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --gradient-primary: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
    --gradient-secondary: linear-gradient(135deg, #7209b7 0%, #560bad 100%);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: var(--dark);
    line-height: 1.6;
}

/* ====================
   MAIN CONTAINER & ANIMATIONS
   ==================== */
.container {
    width: 100%;
    max-width: 1300px;
    display: flex;
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow-lg);
    overflow: hidden;
    min-height: 750px;
    position: relative;
    animation: containerEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes containerEntrance {
    0% {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* ====================
   LEFT PANEL - ADAPTED FROM ORIGINAL DESIGN
   ==================== */
.left-panel {
    flex: 1;
    background: var(--gradient-primary);
    color: white;
    padding: 60px 50px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    position: relative;
    overflow: hidden;
    z-index: 1;
}

.left-panel::before {
    content: '';
    position: absolute;
    top: -100px;
    right: -100px;
    width: 400px;
    height: 400px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    z-index: -1;
    animation: floatingBubble 20s infinite ease-in-out;
}

.left-panel::after {
    content: '';
    position: absolute;
    bottom: -150px;
    left: -150px;
    width: 500px;
    height: 500px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 50%;
    z-index: -1;
    animation: floatingBubble 25s infinite ease-in-out reverse;
}

@keyframes floatingBubble {
    0%, 100% {
        transform: translate(0, 0) rotate(0deg);
    }
    33% {
        transform: translate(30px, -20px) rotate(120deg);
    }
    66% {
        transform: translate(-20px, 15px) rotate(240deg);
    }
}

.logo {
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 50px;
    position: relative;
    z-index: 2;
    animation: slideInLeft 0.6s 0.2s both;
}

.logo i {
    font-size: 2.5rem;
    background: rgba(255, 255, 255, 0.2);
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    animation: bounceIn 0.8s 0.3s both;
}

.panel-content {
    position: relative;
    z-index: 2;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.panel-title {
    font-size: 3rem;
    font-weight: 800;
    margin-bottom: 25px;
    line-height: 1.2;
    background: linear-gradient(135deg, #ffffff 0%, rgba(255,255,255,0.8) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: slideInLeft 0.6s 0.4s both;
}

.panel-description {
    font-size: 1.2rem;
    opacity: 0.9;
    margin-bottom: 50px;
    max-width: 90%;
    animation: slideInLeft 0.6s 0.5s both;
}

.features {
    display: flex;
    flex-direction: column;
    gap: 30px;
    margin-top: 40px;
}

.feature {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: var(--transition);
    animation: fadeInUp 0.6s var(--delay) both;
}

.feature:nth-child(1) { --delay: 0.6s; }
.feature:nth-child(2) { --delay: 0.7s; }
.feature:nth-child(3) { --delay: 0.8s; }

.feature:hover {
    transform: translateX(10px);
    background: rgba(255, 255, 255, 0.15);
}

.feature i {
    font-size: 1.8rem;
    background: rgba(255, 255, 255, 0.2);
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.feature-text h4 {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 8px;
}

.feature-text p {
    font-size: 0.95rem;
    opacity: 0.8;
}

.footer-text {
    position: relative;
    z-index: 2;
    padding-top: 30px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 0.9rem;
    opacity: 0.8;
    animation: fadeIn 0.8s 1s both;
}

/* ====================
   RIGHT PANEL - ENHANCED WITH NEW ANIMATIONS
   ==================== */
.right-panel {
    flex: 1.3;
    padding: 50px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
    animation: slideInRight 0.8s 0.3s both;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3);
    }
    50% {
        opacity: 1;
        transform: scale(1.05);
    }
    70% {
        transform: scale(0.9);
    }
    100% {
        transform: scale(1);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.form-container {
    width: 100%;
    max-width: 550px;
    margin: 0 auto;
}

/* ====================
   TOGGLE CONTAINER - ENHANCED ANIMATION
   ==================== */
.toggle-container {
    display: flex;
    background: var(--gray-light);
    border-radius: 50px;
    padding: 6px;
    margin-bottom: 50px;
    position: relative;
    border: 1px solid rgba(0, 0, 0, 0.05);
    animation: fadeInUp 0.6s 0.5s both;
}

.toggle-btn {
    flex: 1;
    padding: 18px;
    text-align: center;
    background: transparent;
    border: none;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    border-radius: 50px;
    transition: var(--transition);
    color: var(--gray);
    z-index: 1;
    position: relative;
    overflow: hidden;
}

.toggle-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--gradient-primary);
    border-radius: 50px;
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: -1;
}

.toggle-btn.active::before {
    transform: scaleX(1);
}

.toggle-btn.active {
    color: white;
}

.toggle-slider {
    position: absolute;
    top: 6px;
    left: 6px;
    width: calc(50% - 6px);
    height: calc(100% - 12px);
    background: var(--gradient-primary);
    border-radius: 50px;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
    z-index: 0;
}

.toggle-slider.signup {
    transform: translateX(100%);
    background: var(--gradient-secondary);
}

/* ====================
   FORMS - ENHANCED TRANSITIONS
   ==================== */
.form {
    display: none;
    animation: formEntrance 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes formEntrance {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.form.active {
    display: block;
    animation: formEntrance 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.form-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 10px;
    color: var(--dark);
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: fadeInUp 0.5s 0.3s both;
}

.form-subtitle {
    color: var(--gray);
    margin-bottom: 35px;
    font-size: 1rem;
    animation: fadeInUp 0.5s 0.4s both;
}

/* ====================
   INPUT FIELDS - ENHANCED FROM ORIGINAL DESIGN
   ==================== */
.input-group {
    margin-bottom: 25px;
    animation: fadeInUp 0.5s var(--delay) both;
}

.input-group:nth-child(1) { --delay: 0.5s; }
.input-group:nth-child(2) { --delay: 0.6s; }
.input-group:nth-child(3) { --delay: 0.7s; }
.input-group:nth-child(4) { --delay: 0.8s; }

.input-row {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
}

.input-row .input-group {
    flex: 1;
    margin-bottom: 0;
}

label {
    display: block;
    font-weight: 500;
    margin-bottom: 10px;
    color: var(--dark);
    font-size: 0.95rem;
}

.required::after {
    content: ' *';
    color: var(--danger);
}

.optional {
    font-size: 0.85rem;
    color: var(--gray);
    font-weight: normal;
    margin-left: 5px;
}

input, select, textarea {
    width: 100%;
    padding: 16px 20px;
    border: 2px solid var(--gray-light);
    border-radius: 12px;
    font-family: 'Poppins', sans-serif;
    font-size: 1rem;
    transition: var(--transition);
    background: white;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
    transform: translateY(-2px);
}

.input-with-icon {
    position: relative;
}

.input-icon {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray);
    font-size: 1.1rem;
    transition: var(--transition);
}

.input-with-icon input:focus + .input-icon {
    color: var(--primary);
    transform: translateY(-50%) scale(1.1);
}

.input-with-icon input {
    padding-left: 50px;
}

.password-container {
    position: relative;
}

.password-container input {
    padding-right: 60px;
}

.toggle-password {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--gray);
    cursor: pointer;
    font-size: 1.2rem;
    transition: var(--transition);
    padding: 5px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.toggle-password:hover {
    color: var(--primary);
    background: var(--gray-light);
}

/* ====================
   BUTTONS - ENHANCED ANIMATIONS
   ==================== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 18px 35px;
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-family: 'Poppins', sans-serif;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
    position: relative;
    overflow: hidden;
    animation: fadeInUp 0.6s 0.9s both;
}

.btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn:hover::before {
    width: 300px;
    height: 300px;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 30px rgba(67, 97, 238, 0.3);
}

.btn:active {
    transform: translateY(-1px);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

.btn-secondary {
    background: var(--gradient-secondary);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #5a08a0 0%, #4a0790 100%);
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.btn-outline:hover {
    background: var(--gradient-primary);
    color: white;
}

/* ====================
   ACCOUNT TYPE SELECTOR - ENHANCED
   ==================== */
.account-type-selector {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    animation: fadeInUp 0.6s 0.5s both;
}

.account-type-btn {
    flex: 1;
    padding: 20px;
    text-align: center;
    background: var(--gray-light);
    border: 2px solid transparent;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    position: relative;
    overflow: hidden;
}

.account-type-btn i {
    font-size: 1.8rem;
    color: var(--primary);
    transition: var(--transition);
}

.account-type-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--gradient-primary);
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 0;
}

.account-type-btn:hover {
    border-color: var(--primary-light);
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(67, 97, 238, 0.15);
}

.account-type-btn:hover i {
    color: white;
    transform: scale(1.1);
}

.account-type-btn.active {
    background: rgba(67, 97, 238, 0.15);
    border-color: var(--primary);
    color: var(--primary);
    box-shadow: 0 5px 15px rgba(67, 97, 238, 0.2);
}

.account-type-btn.active::before {
    opacity: 0.1;
}

/* ====================
   CONDITIONAL FIELDS - ENHANCED ANIMATIONS
   ==================== */
.conditional-fields {
    background: rgba(67, 97, 238, 0.05);
    border-radius: 16px;
    padding: 25px;
    margin-top: 25px;
    border-left: 4px solid var(--primary);
    animation: slideDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes slideDown {
    from { 
        opacity: 0;
        transform: translateY(-15px) scale(0.95);
    }
    to { 
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.conditional-fields h4 {
    font-size: 1.2rem;
    margin-bottom: 20px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

/* ====================
   GURU ROLE SELECTOR
   ==================== */
.guru-role-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 30px;
}

.role-btn {
    padding: 15px;
    text-align: center;
    background: var(--gray-light);
    border: 2px solid transparent;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.95rem;
}

.role-btn:hover {
    background: rgba(67, 97, 238, 0.1);
    border-color: var(--primary-light);
    transform: translateY(-2px);
}

.role-btn.active {
    background: rgba(67, 97, 238, 0.15);
    border-color: var(--primary);
    color: var(--primary);
    box-shadow: 0 5px 15px rgba(67, 97, 238, 0.2);
}

/* ====================
   DYNAMIC FIELDS ANIMATIONS
   ==================== */
.mapel-container {
    margin-bottom: 25px;
    background: white;
    border-radius: 12px;
    padding: 25px;
    border: 1px solid var(--gray-light);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    animation: fadeInUp 0.4s ease;
}

.mapel-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.mapel-header h5 {
    flex: 1;
    font-size: 1.1rem;
    color: var(--dark);
}

.kelas-list {
    margin-left: 35px;
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.kelas-item {
    display: flex;
    align-items: center;
    gap: 20px;
    animation: slideInRight 0.3s ease;
}

.kelas-item select {
    flex: 1;
}

.add-btn, .remove-btn {
    padding: 12px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.95rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
}

.add-btn::before, .remove-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.add-btn:hover::before, .remove-btn:hover::before {
    width: 200px;
    height: 200px;
}

.remove-btn {
    background: var(--danger);
    padding: 10px 15px;
}

.add-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
}

.remove-btn:hover {
    background: #d63384;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3);
}

/* ====================
   STATUS CONTAINER - ENHANCED ANIMATIONS
   ==================== */
.status-container {
    margin-top: 30px;
    padding: 25px;
    border-radius: 16px;
    display: none;
    animation: statusEntrance 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

@keyframes statusEntrance {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.status-container.success {
    background: rgba(76, 201, 240, 0.15);
    border-color: rgba(76, 201, 240, 0.3);
    color: #0d6efd;
}

.status-container.error {
    background: rgba(247, 37, 133, 0.15);
    border-color: rgba(247, 37, 133, 0.3);
    color: #dc3545;
}

.status-container.loading {
    background: rgba(67, 97, 238, 0.15);
    border-color: rgba(67, 97, 238, 0.3);
    color: var(--primary);
}

.status-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.status-header i {
    font-size: 1.8rem;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.7;
        transform: scale(1.05);
    }
}

.status-title {
    font-weight: 700;
    font-size: 1.3rem;
}

.status-message {
    margin-bottom: 20px;
    line-height: 1.6;
}

.status-progress {
    height: 8px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 20px;
}

.progress-bar {
    height: 100%;
    background: var(--success);
    width: 0%;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 4px;
    animation: progressPulse 1.5s infinite;
}

@keyframes progressPulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

/* ====================
   MODAL - ENHANCED ANIMATIONS
   ==================== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
    backdrop-filter: blur(5px);
}

.modal-content {
    background: white;
    border-radius: var(--border-radius);
    width: 90%;
    max-width: 700px;
    padding: 40px;
    position: relative;
    box-shadow: var(--box-shadow-lg);
    animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes modalSlideUp {
    from { 
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
    to { 
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.modal-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--dark);
}

.close-modal {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: var(--gray);
    transition: var(--transition);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.close-modal:hover {
    background: var(--gray-light);
    color: var(--dark);
    transform: rotate(90deg);
}

#camera-preview {
    width: 100%;
    height: 400px;
    background: var(--dark);
    border-radius: 12px;
    margin-bottom: 30px;
    object-fit: cover;
    transform: scaleX(-1);
    animation: cameraPreviewEntrance 0.5s ease;
}

@keyframes cameraPreviewEntrance {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* ====================
   DIVIDER - ENHANCED
   ==================== */
.divider {
    display: flex;
    align-items: center;
    margin: 30px 0;
    color: var(--gray);
    animation: fadeInUp 0.6s 0.8s both;
}

.divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--gray-light);
    transition: all 0.3s;
}

.divider:hover::before, .divider:hover::after {
    background: var(--primary);
    height: 2px;
}

.divider span {
    padding: 0 20px;
    font-size: 0.9rem;
    transition: var(--transition);
}

.divider:hover span {
    color: var(--primary);
    transform: scale(1.1);
}

/* ====================
   SOCIAL BUTTONS - ENHANCED
   ==================== */
.social-login {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin: 25px 0;
    animation: fadeInUp 0.6s 0.7s both;
}

.social-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 15px;
    border: 2px solid var(--gray-light);
    background: white;
    border-radius: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.social-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.05);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.social-btn:hover::before {
    width: 200px;
    height: 200px;
}

.social-btn:hover {
    border-color: var(--primary);
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.social-btn.google {
    color: #DB4437;
}

.social-btn.microsoft {
    color: #00A4EF;
}

/* ====================
   PHOTO UPLOAD - ENHANCED
   ==================== */
.photo-upload-container {
    display: flex;
    align-items: center;
    gap: 30px;
    animation: fadeInUp 0.6s 0.6s both;
}

.photo-preview {
    width: 140px;
    height: 140px;
    border-radius: 50%;
    overflow: hidden;
    border: 4px solid var(--primary-light);
    background: var(--gray-light);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: var(--transition);
    position: relative;
}

.photo-preview:hover {
    transform: scale(1.05);
    box-shadow: 0 15px 40px rgba(67, 97, 238, 0.2);
}

.photo-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.photo-upload-buttons {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.photo-btn {
    padding: 15px;
    text-align: center;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    border: 2px solid transparent;
    position: relative;
    overflow: hidden;
}

.photo-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.photo-btn:hover::before {
    width: 200px;
    height: 200px;
}

.photo-btn.upload {
    background: var(--gradient-primary);
    color: white;
    border: none;
}

.photo-btn.camera {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.photo-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.photo-btn.camera:hover {
    background: var(--gradient-primary);
    color: white;
}

/* ====================
   RESPONSIVE DESIGN
   ==================== */
@media (max-width: 1200px) {
    .container {
        max-width: 1000px;
    }
    
    .panel-title {
        font-size: 2.5rem;
    }
}

@media (max-width: 992px) {
    .container {
        flex-direction: column;
        max-width: 700px;
        min-height: auto;
        animation: containerEntranceMobile 0.8s ease;
    }

    @keyframes containerEntranceMobile {
        0% {
            opacity: 0;
            transform: translateY(30px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .left-panel {
        padding: 40px;
        animation: slideInDown 0.6s ease;
    }

    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .right-panel {
        padding: 40px;
        animation: slideInUp 0.6s ease;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .panel-title {
        font-size: 2.2rem;
    }

    .input-row {
        flex-direction: column;
        gap: 0;
    }

    .photo-upload-container {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .photo-upload-buttons {
        width: 100%;
    }

    .guru-role-selector {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 576px) {
    body {
        padding: 10px;
        animation: bodyEntrance 0.8s ease;
    }

    @keyframes bodyEntrance {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .container {
        padding: 0;
        border-radius: 0;
        animation: containerEntranceSmall 0.6s ease;
    }

    @keyframes containerEntranceSmall {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .left-panel, .right-panel {
        padding: 30px 25px;
    }

    .account-type-selector {
        flex-direction: column;
    }

    .mapel-container {
        padding: 20px;
    }

    .kelas-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }

    .kelas-item select {
        width: 100%;
    }

    .social-login {
        grid-template-columns: 1fr;
    }

    .modal-content {
        padding: 25px;
    }
    
    .camera-controls {
        flex-direction: column;
    }
    
    .camera-controls .btn {
        width: 100%;
    }
}

/* ====================
   LOADING ANIMATIONS
   ==================== */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* ====================
   FORM ELEMENT ANIMATIONS
   ==================== */
input:valid, select:valid, textarea:valid {
    border-color: #06d6a0;
}

input:invalid:not(:focus):not(:placeholder-shown), 
select:invalid:not(:focus), 
textarea:invalid:not(:focus):not(:placeholder-shown) {
    border-color: var(--danger);
    animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
}

@keyframes shake {
    10%, 90% {
        transform: translateX(-1px);
    }
    20%, 80% {
        transform: translateX(2px);
    }
    30%, 50%, 70% {
        transform: translateX(-3px);
    }
    40%, 60% {
        transform: translateX(3px);
    }
}

/* ====================
   FLOATING ANIMATIONS
   ==================== */
@keyframes float {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

.logo i, .feature i {
    animation: float 3s ease-in-out infinite;
}

.logo i {
    animation-delay: 0.5s;
}

.feature:nth-child(1) i {
    animation-delay: 0.2s;
}

.feature:nth-child(2) i {
    animation-delay: 0.4s;
}

.feature:nth-child(3) i {
    animation-delay: 0.6s;
}

/* ====================
   GLOW EFFECTS
   ==================== */
.glow {
    animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
    from {
        box-shadow: 0 0 10px rgba(67, 97, 238, 0.5);
    }
    to {
        box-shadow: 0 0 20px rgba(67, 97, 238, 0.8), 0 0 30px rgba(67, 97, 238, 0.6);
    }
}

.toggle-btn.active {
    animation: glow 2s ease-in-out infinite alternate;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel -->
        <div class="left-panel">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <span>Smart Mudarris</span>
            </div>

            <div class="panel-content">
                <h1 class="panel-title">Sistem Pendidikan Digital Terpadu</h1>
                <p class="panel-description">Platform modern untuk manajemen sekolah, pembelajaran digital, dan kolaborasi antara guru, siswa, dan orang tua.</p>
            </div>

            <div class="footer-text">
                <p>© 2025 Smart Mudarris. All rights reserved. | <a href="#" style="color: rgba(255,255,255,0.8); text-decoration: none;">Privacy Policy</a> • <a href="#" style="color: rgba(255,255,255,0.8); text-decoration: none;">Terms of Service</a></p>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="form-container">
                <!-- Toggle Buttons -->
                <div class="toggle-container">
                    <div class="toggle-slider"></div>
                    <button class="toggle-btn active" id="login-toggle">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <button class="toggle-btn" id="signup-toggle">
                        <i class="fas fa-user-plus"></i> Daftar Akun
                    </button>
                </div>

                <!-- Login Form -->
                <div class="form active" id="login-form">
                    <h2 class="form-title">Selamat Datang Kembali</h2>
                    <p class="form-subtitle">Masuk ke akun Anda untuk melanjutkan</p>

                    <div class="input-group">
                        <label for="login-email" class="required">Email</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" id="login-email" placeholder="nama@example.com" required>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="login-password" class="required">Password</label>
                        <div class="password-container">
                            <input type="password" id="login-password" placeholder="Masukkan password" required>
                            <button type="button" class="toggle-password" id="toggle-login-password">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="forgot-password">
                        <a href="#" id="forgot-password-link">Lupa password?</a>
                    </div>

                    <button class="btn" id="login-btn">
                        <i class="fas fa-sign-in-alt"></i> Masuk ke Akun
                    </button>

                    <div class="divider">
                        <span>Atau lanjutkan dengan</span>
                    </div>

                    <div class="social-login">
                        <button class="social-btn google" id="google-login">
                            <i class="fab fa-google"></i> Google
                        </button>
                        <button class="social-btn microsoft" id="microsoft-login">
                            <i class="fab fa-microsoft"></i> Microsoft
                        </button>
                    </div>

                    <p class="form-subtitle text-center">Belum punya akun? <a href="#" id="switch-to-signup" style="color: var(--primary); font-weight: 600; text-decoration: none;">Daftar sekarang</a></p>
                </div>

                <!-- Signup Form -->
                <div class="form" id="signup-form">
                    <h2 class="form-title">Buat Akun Baru</h2>
                    <p class="form-subtitle">Isi data berikut untuk mendaftar akun</p>

                    <!-- Account Type Selector -->
                    <div class="account-type-selector">
                        <div class="account-type-btn" data-type="siswa">
                            <i class="fas fa-user-graduate"></i>
                            <span>Siswa</span>
                        </div>
                        <div class="account-type-btn active" data-type="guru">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Guru</span>
                        </div>
                        <div class="account-type-btn" data-type="admin">
                            <i class="fas fa-user-cog"></i>
                            <span>Admin</span>
                        </div>
                    </div>

                    <!-- Common Fields -->
                    <div class="input-row">
                        <div class="input-group">
                            <label for="signup-nama" class="required">Nama Lengkap</label>
                            <div class="input-with-icon">
                                <i class="fas fa-user input-icon"></i>
                                <input type="text" id="signup-nama" placeholder="Nama lengkap" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="signup-email" class="required">Email</label>
                            <div class="input-with-icon">
                                <i class="fas fa-envelope input-icon"></i>
                                <input type="email" id="signup-email" placeholder="nama@example.com" required>
                            </div>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label for="signup-password" class="required">Password</label>
                            <div class="password-container">
                                <input type="password" id="signup-password" placeholder="Minimal 8 karakter" minlength="8" required>
                                <button type="button" class="toggle-password" id="toggle-signup-password">
                                    <i class="far fa-eye"></i>
                                </button>
                            </div>
                            <div class="password-strength" id="password-strength" style="margin-top: 8px; font-size: 0.85rem; display: none;"></div>
                        </div>
                        <div class="input-group">
                            <label for="signup-confirm-password" class="required">Konfirmasi Password</label>
                            <div class="password-container">
                                <input type="password" id="signup-confirm-password" placeholder="Ulangi password" required>
                                <button type="button" class="toggle-password" id="toggle-confirm-password">
                                    <i class="far fa-eye"></i>
                                </button>
                            </div>
                            <div class="password-match" id="password-match" style="margin-top: 8px; font-size: 0.85rem; display: none;"></div>
                        </div>
                    </div>

                    <!-- WhatsApp (Optional) -->
                    <div class="input-group">
                        <label for="signup-whatsapp">Nomor WhatsApp <span class="optional">(opsional)</span></label>
                        <div class="input-with-icon">
                            <i class="fas fa-phone input-icon"></i>
                            <input type="tel" id="signup-whatsapp" placeholder="Contoh: 081234567890" pattern="[0-9]{10,13}">
                        </div>
                    </div>

                    <!-- Photo Upload -->
                    <div class="input-group">
                        <label>Foto Profil <span class="optional">(opsional)</span></label>
                        <div class="photo-upload-container">
                            <div class="photo-preview" id="photo-preview">
                                <i class="fas fa-user" style="font-size: 3.5rem; color: var(--gray);"></i>
                            </div>
                            <div class="photo-upload-buttons">
                                <button class="photo-btn upload" id="upload-photo">
                                    <i class="fas fa-upload"></i> Upload Foto
                                </button>
                                <button class="photo-btn camera" id="open-camera">
                                    <i class="fas fa-camera"></i> Ambil Foto Selfie
                                </button>
                                <input type="file" id="photo-input" accept="image/*" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <!-- Conditional Fields for Siswa -->
                    <div class="conditional-fields" id="siswa-fields" style="display: none;">
                        <h4><i class="fas fa-user-graduate"></i> Data Siswa</h4>

                        <div class="input-group">
                            <label for="siswa-kelas" class="required">Kelas</label>
                            <select id="siswa-kelas" required>
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label for="siswa-nis">NIS <span class="optional">(opsional)</span></label>
                                <input type="text" id="siswa-nis" placeholder="Nomor Induk Siswa">
                            </div>
                            <div class="input-group">
                                <label for="siswa-nisn">NISN <span class="optional">(opsional)</span></label>
                                <input type="text" id="siswa-nisn" placeholder="Nomor Induk Siswa Nasional">
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="siswa-alamat">Alamat <span class="optional">(opsional)</span></label>
                            <textarea id="siswa-alamat" rows="2" placeholder="Alamat tempat tinggal"></textarea>
                        </div>

                        <div class="input-group">
                            <label for="siswa-ortu">Nama Orang Tua/Wali <span class="optional">(opsional)</span></label>
                            <input type="text" id="siswa-ortu" placeholder="Nama lengkap orang tua/wali">
                        </div>
                    </div>

                    <!-- Conditional Fields for Guru -->
                    <div class="conditional-fields" id="guru-fields">
                        <h4><i class="fas fa-chalkboard-teacher"></i> Data Guru</h4>

                        <div class="input-row">
                            <div class="input-group">
                                <label for="guru-nip">NIP <span class="optional">(opsional)</span></label>
                                <input type="text" id="guru-nip" placeholder="Nomor Induk Pegawai">
                            </div>
                            <div class="input-group">
                                <label for="guru-nuptk">NUPTK <span class="optional">(opsional)</span></label>
                                <input type="text" id="guru-nuptk" placeholder="Nomor Unik Pendidik & Tenaga Kependidikan">
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="guru-alamat">Alamat <span class="optional">(opsional)</span></label>
                            <textarea id="guru-alamat" rows="2" placeholder="Alamat tempat tinggal"></textarea>
                        </div>

                        <!-- Guru Role Selector -->
                        <div class="input-group">
                            <label class="required">Peran Guru</label>
                            <div class="guru-role-selector">
                                <div class="role-btn active" data-role="umum">Guru Umum</div>
                                <div class="role-btn" data-role="wali">Wali Kelas</div>
                                <div class="role-btn" data-role="mapel">Guru Mapel</div>
                            </div>
                        </div>

                        <!-- Guru Umum Fields -->
                        <div class="conditional-fields" id="guru-umum-fields">
                            <h5><i class="fas fa-users"></i> Kelas yang Dipegang</h5>
                            <div id="umum-kelas-container">
                                <div class="input-group">
                                    <label class="required">Kelas 1</label>
                                    <select class="umum-kelas-select" required>
                                        <option value="">Pilih Kelas</option>
                                    </select>
                                </div>
                            </div>
                            <button type="button" class="add-btn" id="add-umum-kelas">
                                <i class="fas fa-plus"></i> Tambah Kelas
                            </button>
                        </div>

                        <!-- Wali Kelas Fields -->
                        <div class="conditional-fields" id="guru-wali-fields" style="display: none;">
                            <div class="input-group">
                                <label for="wali-kelas" class="required">Kelas yang Dipegang</label>
                                <select id="wali-kelas" required>
                                    <option value="">Pilih Kelas</option>
                                </select>
                            </div>
                        </div>

                        <!-- Guru Mapel Fields -->
                        <div class="conditional-fields" id="guru-mapel-fields" style="display: none;">
                            <h5><i class="fas fa-book"></i> Mata Pelajaran & Kelas</h5>
                            <div id="mapel-container">
                                <div class="mapel-container">
                                    <div class="mapel-header">
                                        <h5>Mata Pelajaran 1</h5>
                                        <button type="button" class="remove-btn remove-mapel">
                                            <i class="fas fa-trash"></i> Hapus
                                        </button>
                                    </div>
                                    <div class="input-group">
                                        <select class="mapel-select" required>
                                            <option value="">Pilih Mata Pelajaran</option>
                                        </select>
                                    </div>
                                    <div class="kelas-list">
                                        <div class="kelas-item">
                                            <select class="kelas-select" required>
                                                <option value="">Pilih Kelas</option>
                                            </select>
                                            <button type="button" class="remove-btn remove-kelas">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="button" class="add-btn add-kelas">
                                        <i class="fas fa-plus"></i> Tambah Kelas
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="add-btn" id="add-mapel">
                                <i class="fas fa-plus"></i> Tambah Mata Pelajaran
                            </button>
                        </div>
                    </div>

                    <!-- Conditional Fields for Admin -->
                    <div class="conditional-fields" id="admin-fields" style="display: none;">
                        <h4><i class="fas fa-user-cog"></i> Data Admin</h4>
                        <div class="input-group">
                            <label for="admin-jabatan" class="required">Jabatan</label>
                            <select id="admin-jabatan" required>
                                <option value="">Pilih Jabatan</option>
                                <option value="kepsek">Kepala Sekolah</option>
                                <option value="wakasek">Wakil Kepala Sekolah</option>
                                <option value="tu">Tata Usaha</option>
                                <option value="bendahara">Bendahara</option>
                                <option value="admin_umum">Admin Umum</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="admin-departemen">Departemen <span class="optional">(opsional)</span></label>
                            <input type="text" id="admin-departemen" placeholder="Departemen/Unit Kerja">
                        </div>
                    </div>

                    <!-- Terms & Conditions -->
                    <div class="terms-container">
                        <div class="terms-checkbox">
                            <input type="checkbox" id="terms-agreement" required>
                            <div class="terms-text">
                                Saya menyetujui <a href="#" id="terms-link">Syarat & Ketentuan</a> dan <a href="#" id="privacy-link">Kebijakan Privasi</a> Smart Mudarris. Saya memahami bahwa data saya akan diproses sesuai dengan kebijakan yang berlaku.
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-secondary" id="signup-btn">
                        <i class="fas fa-user-plus"></i> Daftar Akun
                    </button>

                    <div class="divider">
                        <span>Atau</span>
                    </div>

                    <p class="form-subtitle text-center">Sudah punya akun? <a href="#" id="switch-to-login" style="color: var(--primary); font-weight: 600; text-decoration: none;">Masuk sekarang</a></p>
                </div>

                <!-- Forgot Password Form -->
                <div class="form" id="forgot-password-form" style="display: none;">
                    <h2 class="form-title">Reset Password</h2>
                    <p class="form-subtitle">Masukkan email Anda untuk menerima link reset password</p>

                    <div class="input-group">
                        <label for="reset-email" class="required">Email</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" id="reset-email" placeholder="nama@example.com" required>
                        </div>
                    </div>

                    <button class="btn" id="reset-password-btn">
                        <i class="fas fa-paper-plane"></i> Kirim Link Reset
                    </button>

                    <div class="divider">
                        <span>Atau</span>
                    </div>

                    <p class="form-subtitle text-center">Ingat password? <a href="#" id="switch-to-login-2" style="color: var(--primary); font-weight: 600; text-decoration: none;">Masuk sekarang</a></p>
                </div>

                <!-- Status Container -->
                <div class="status-container" id="status-container">
                    <div class="status-header">
                        <i id="status-icon"></i>
                        <div class="status-title" id="status-title"></div>
                    </div>
                    <div class="status-message" id="status-message"></div>
                    <div class="status-progress">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div class="modal" id="camera-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Ambil Foto Selfie</h3>
                <button class="close-modal" id="close-camera">&times;</button>
            </div>
            <video id="camera-preview" autoplay></video>
            <div class="camera-controls">
                <button class="btn" id="capture-photo">
                    <i class="fas fa-camera"></i> Ambil Foto
                </button>
                <button class="btn btn-outline" id="switch-camera">
                    <i class="fas fa-sync-alt"></i> Ganti Kamera
                </button>
                <button class="btn btn-outline" id="close-camera-btn">
                    <i class="fas fa-times"></i> Tutup
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================
        // SUPABASE CONFIGURATION
        // ====================
        // GANTI DENGAN KONFIGURASI PROJEK ANDA
        const SUPABASE_URL = 'https://lgsufwalckbbdlhyqchp.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_On-J7LB2g9ND4zXtZA7IbA_KMmP-rsZ';

        // Inisialisasi Supabase Client
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ====================
        // APPLICATION STATE
        // ====================
        let currentAccountType = 'guru';
        let currentGuruRole = 'umum';
        let photoDataUrl = null;
        let stream = null;
        let cameraFacingMode = 'user'; // 'user' for front camera, 'environment' for back
        let kelasData = [];
        let mapelData = [];
        let isLoading = false;

        // ====================
        // DOM ELEMENTS
        // ====================
        const loginToggle = document.getElementById('login-toggle');
        const signupToggle = document.getElementById('signup-toggle');
        const toggleSlider = document.querySelector('.toggle-slider');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const switchToSignup = document.getElementById('switch-to-signup');
        const switchToLogin = document.getElementById('switch-to-login');
        const switchToLogin2 = document.getElementById('switch-to-login-2');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const accountTypeBtns = document.querySelectorAll('.account-type-btn');
        const siswaFields = document.getElementById('siswa-fields');
        const guruFields = document.getElementById('guru-fields');
        const adminFields = document.getElementById('admin-fields');
        const guruRoleBtns = document.querySelectorAll('.role-btn');
        const guruUmumFields = document.getElementById('guru-umum-fields');
        const guruWaliFields = document.getElementById('guru-wali-fields');
        const guruMapelFields = document.getElementById('guru-mapel-fields');
        const siswaKelasSelect = document.getElementById('siswa-kelas');
        const waliKelasSelect = document.getElementById('wali-kelas');
        const adminJabatanSelect = document.getElementById('admin-jabatan');
        const statusContainer = document.getElementById('status-container');
        const statusTitle = document.getElementById('status-title');
        const statusMessage = document.getElementById('status-message');
        const statusIcon = document.getElementById('status-icon');
        const progressBar = document.getElementById('progress-bar');
        const cameraModal = document.getElementById('camera-modal');
        const cameraPreview = document.getElementById('camera-preview');
        const closeCamera = document.getElementById('close-camera');
        const closeCameraBtn = document.getElementById('close-camera-btn');
        const switchCameraBtn = document.getElementById('switch-camera');
        const capturePhotoBtn = document.getElementById('capture-photo');
        const openCameraBtn = document.getElementById('open-camera');
        const photoInput = document.getElementById('photo-input');
        const photoPreview = document.getElementById('photo-preview');
        const uploadPhotoBtn = document.getElementById('upload-photo');
        const addUmumKelasBtn = document.getElementById('add-umum-kelas');
        const addMapelBtn = document.getElementById('add-mapel');
        const umumKelasContainer = document.getElementById('umum-kelas-container');
        const mapelContainer = document.getElementById('mapel-container');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        const googleLoginBtn = document.getElementById('google-login');
        const microsoftLoginBtn = document.getElementById('microsoft-login');
        const passwordStrength = document.getElementById('password-strength');
        const passwordMatch = document.getElementById('password-match');
        const termsAgreement = document.getElementById('terms-agreement');

        // ====================
        // INITIALIZATION
        // ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            setupEventListeners();
            
            // Check for existing session
            await checkSession();
            
            // Fetch initial data
            await Promise.all([
                fetchKelasData(),
                fetchMapelData()
            ]);
            
            // Set default for form guru umum
            addKelasSelect(umumKelasContainer, 'umum');
            
            // Add initial mapel field
            addMapelField();
        }
        
        

        // ====================
        // SESSION MANAGEMENT
        // ====================
        async function checkSession() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) throw error;
                
                if (session) {
                    // User is already logged in, redirect to dashboard
                    const { data: profile } = await supabaseClient
                        .from('profiles')
                        .select('tipe_akun')
                        .eq('id', session.user.id)
                        .single();
                    
                    if (profile) {
                        redirectToDashboard(profile.tipe_akun);
                    }
                }
            } catch (error) {
                console.error('Session check error:', error);
            }
        }

        // ====================
        // EVENT LISTENERS SETUP
        // ====================
        function setupEventListeners() {
            // Toggle login/signup/forgot password
            loginToggle.addEventListener('click', () => switchForm('login'));
            signupToggle.addEventListener('click', () => switchForm('signup'));
            switchToSignup.addEventListener('click', (e) => {
                e.preventDefault();
                switchForm('signup');
            });
            switchToLogin.addEventListener('click', (e) => {
                e.preventDefault();
                switchForm('login');
            });
            switchToLogin2.addEventListener('click', (e) => {
                e.preventDefault();
                switchForm('login');
            });
            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                switchForm('forgot-password');
            });

            // Toggle password visibility
            setupPasswordToggles();

            // Account type selector
            accountTypeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    accountTypeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentAccountType = btn.dataset.type;
                    updateAccountTypeFields();
                });
            });

            // Guru role selector
            guruRoleBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    guruRoleBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentGuruRole = btn.dataset.role;
                    updateGuruRoleFields();
                });
            });

            // Photo upload
            uploadPhotoBtn.addEventListener('click', () => photoInput.click());
            photoInput.addEventListener('change', handlePhotoUpload);
            openCameraBtn.addEventListener('click', openCamera);

            // Camera modal
            closeCamera.addEventListener('click', closeCameraModal);
            closeCameraBtn.addEventListener('click', closeCameraModal);
            switchCameraBtn.addEventListener('click', switchCamera);
            capturePhotoBtn.addEventListener('click', capturePhoto);

            // Dynamic fields
            addUmumKelasBtn.addEventListener('click', () => addKelasSelect(umumKelasContainer, 'umum'));
            addMapelBtn.addEventListener('click', addMapelField);

            // Form submissions
            loginBtn.addEventListener('click', handleLogin);
            signupBtn.addEventListener('click', handleSignup);
            resetPasswordBtn.addEventListener('click', handleResetPassword);
            
            // Social login
            googleLoginBtn.addEventListener('click', () => handleSocialLogin('google'));
            microsoftLoginBtn.addEventListener('click', () => handleSocialLogin('azure'));

            // Password validation
            document.getElementById('signup-password').addEventListener('input', validatePasswordStrength);
            document.getElementById('signup-confirm-password').addEventListener('input', validatePasswordMatch);

            // Terms agreement
            termsAgreement.addEventListener('change', updateSignupButtonState);

            // Enter key support
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    if (loginForm.classList.contains('active')) {
                        handleLogin();
                    } else if (signupForm.classList.contains('active')) {
                        handleSignup();
                    } else if (forgotPasswordForm.classList.contains('active')) {
                        handleResetPassword();
                    }
                }
            });
        }

        // ====================
        // FORM MANAGEMENT
        // ====================
        function switchForm(formType) {
            // Reset all forms
            loginToggle.classList.remove('active');
            signupToggle.classList.remove('active');
            toggleSlider.classList.remove('signup');
            
            loginForm.classList.remove('active');
            signupForm.classList.remove('active');
            forgotPasswordForm.classList.remove('active');
            
            hideStatus();

            // Show selected form
            switch(formType) {
                case 'login':
                    loginToggle.classList.add('active');
                    loginForm.classList.add('active');
                    break;
                case 'signup':
                    signupToggle.classList.add('active');
                    signupForm.classList.add('active');
                    toggleSlider.classList.add('signup');
                    updateSignupButtonState();
                    break;
                case 'forgot-password':
                    forgotPasswordForm.classList.add('active');
                    break;
            }
        }

        function updateAccountTypeFields() {
            siswaFields.style.display = currentAccountType === 'siswa' ? 'block' : 'none';
            guruFields.style.display = currentAccountType === 'guru' ? 'block' : 'none';
            adminFields.style.display = currentAccountType === 'admin' ? 'block' : 'none';
        }

        function updateGuruRoleFields() {
            guruUmumFields.style.display = currentGuruRole === 'umum' ? 'block' : 'none';
            guruWaliFields.style.display = currentGuruRole === 'wali' ? 'block' : 'none';
            guruMapelFields.style.display = currentGuruRole === 'mapel' ? 'block' : 'none';
        }

        function updateSignupButtonState() {
            signupBtn.disabled = !termsAgreement.checked;
        }

        // ====================
        // PASSWORD HANDLING
        // ====================
        function setupPasswordToggles() {
            const toggleButtons = [
                { button: 'toggle-login-password', input: 'login-password' },
                { button: 'toggle-signup-password', input: 'signup-password' },
                { button: 'toggle-confirm-password', input: 'signup-confirm-password' }
            ];

            toggleButtons.forEach(item => {
                const button = document.getElementById(item.button);
                const input = document.getElementById(item.input);

                button.addEventListener('click', () => {
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);

                    // Update icon
                    const icon = button.querySelector('i');
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                });
            });
        }

        function validatePasswordStrength() {
            const password = document.getElementById('signup-password').value;
            const strengthDiv = passwordStrength;
            
            if (!password) {
                strengthDiv.style.display = 'none';
                return;
            }

            let strength = 0;
            let message = '';
            let color = '';

            // Check criteria
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            switch(strength) {
                case 0:
                case 1:
                    message = 'Sangat lemah';
                    color = '#f72585';
                    break;
                case 2:
                    message = 'Lemah';
                    color = '#ff9e00';
                    break;
                case 3:
                    message = 'Cukup';
                    color = '#ffd166';
                    break;
                case 4:
                    message = 'Kuat';
                    color = '#4cc9f0';
                    break;
                case 5:
                    message = 'Sangat kuat';
                    color = '#06d6a0';
                    break;
            }

            strengthDiv.style.display = 'block';
            strengthDiv.textContent = `Kekuatan password: ${message}`;
            strengthDiv.style.color = color;
        }

        function validatePasswordMatch() {
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            const matchDiv = passwordMatch;
            
            if (!password || !confirmPassword) {
                matchDiv.style.display = 'none';
                return;
            }

            if (password === confirmPassword) {
                matchDiv.style.display = 'block';
                matchDiv.textContent = '✓ Password cocok';
                matchDiv.style.color = '#06d6a0';
            } else {
                matchDiv.style.display = 'block';
                matchDiv.textContent = '✗ Password tidak cocok';
                matchDiv.style.color = '#f72585';
            }
        }

        // ====================
        // DATA FETCHING
        // ====================
        async function fetchKelasData() {
            try {
                const { data, error } = await supabaseClient
                    .from('kelas')
                    .select('id, nama_kelas, tahun_ajaran')
                    .order('tahun_ajaran')
                    .order('nama_kelas');

                if (error) throw error;

                kelasData = data || [];
                
                // Populate kelas dropdowns
                populateKelasDropdown(siswaKelasSelect);
                populateKelasDropdown(waliKelasSelect);
                
                // Also populate for guru umum and mapel
                document.querySelectorAll('.umum-kelas-select, .kelas-select').forEach(select => {
                    if (select.id !== 'siswa-kelas' && select.id !== 'wali-kelas') {
                        populateKelasDropdown(select);
                    }
                });

            } catch (error) {
                console.error('Error fetching kelas data:', error.message);
                // Fallback data for demo
                kelasData = [
        { id: '0141ee30-d098-44e6-9e5c-d7660ac3d583', nama_kelas: '3B', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: '0722d971-e04c-41ef-97ac-8d147f73caed', nama_kelas: '2A', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: '1fe44016-5b07-44da-be61-06d4ccc8f7ef', nama_kelas: '5C', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: '33f9a5e3-c7a5-4718-a00e-974757c55721', nama_kelas: '2B', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: '3619fb64-cda3-499c-91b1-d4a8db4e84be', nama_kelas: '5A', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: '639d9d18-bdbf-4a28-8976-b4e2268aabc2', nama_kelas: '4C', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: '6f5ccee8-7b5f-4bd5-8a5f-0ee7d20e7464', nama_kelas: '3A', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: '78c44f10-9526-4b26-8b22-a5e4f05b2377', nama_kelas: '6B', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: '9b42c66f-dd60-47b1-bd45-6bf433343feb', nama_kelas: '5B', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: 'a5f1c8b3-e205-4169-908f-70252029b01e', nama_kelas: '4B', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: 'a97e5e53-504c-4c7f-a694-d79a3ea87b35', nama_kelas: '3C', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: 'b8645975-4956-4adf-80b0-bbcee7e7a3b9', nama_kelas: '6C', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: 'ba65a075-2154-4779-98e4-9789113c8448', nama_kelas: '1C', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: 'c1cd0e9b-97b9-448a-9248-a42831150c7b', nama_kelas: '4A', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: 'cfd01166-a732-4fb8-9792-63a7349e6a2f', nama_kelas: '2C', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: 'd45e7497-1ab3-4206-a28e-0231b93e57af', nama_kelas: '1B', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: 'da8501e0-39fc-41be-9884-93fbf407f5cc', nama_kelas: '6A', tahun_ajaran: '2025/2026', wali_guru_id: null },
        { id: 'e3f663a7-520a-4bcc-a89f-28f7594bdbea', nama_kelas: '1A', tahun_ajaran: '2025/2026', wali_guru_id: null }
                ];
                
                // Populate with fallback data
                populateKelasDropdown(siswaKelasSelect);
                populateKelasDropdown(waliKelasSelect);
            }
        }

        async function fetchMapelData() {
            try {
                const { data, error } = await supabaseClient
                    .from('mapel')
                    .select('id, nama_mapel, jenjang')
                    .order('nama_mapel');

                if (error) throw error;

                mapelData = data || [];
                
                // Populate mapel dropdowns
                document.querySelectorAll('.mapel-select').forEach(select => {
                    populateMapelDropdown(select);
                });

            } catch (error) {
                console.error('Error fetching mapel data:', error.message);
                // Fallback data for demo
                mapelData = [
        { id: '05cc4187-f88b-46b5-a252-54bc5341438b', nama_mapel: 'Akidah Akhlak', jenjang: 'SD/MI' },
        { id: '0e20a725-3998-4a25-9727-2e06a82f2e95', nama_mapel: 'Bahasa Arab', jenjang: 'SD/MI' },
        { id: '175f5be4-aedb-42f1-898d-06ca6bb6febb', nama_mapel: 'Bahasa Inggris', jenjang: 'SD/MI' },
        { id: '1ed551e2-1c09-46b8-98a8-c19ce317ed10', nama_mapel: 'SKI - Sejarah Kebudayaan Islam', jenjang: 'SD/MI' },
        { id: '215fbca0-3976-449b-b387-eb225b00c657', nama_mapel: 'Al-Qur\'an dan Hadis', jenjang: 'SD/MI' },
        { id: '361f187d-f6aa-43bf-bbb8-8410f84b5cfe', nama_mapel: 'IPAS - Ilmu Pengetahuan Alam dan Sosial', jenjang: 'SD/MI' },
        { id: '4257e4c4-f83a-4f9f-8d21-72926d3f3230', nama_mapel: 'Fikih', jenjang: 'SD/MI' },
        { id: '4840077a-b00b-4f29-9606-7eae6dd0f5f7', nama_mapel: 'Matematika', jenjang: 'SD/MI' },
        { id: '61dfd9df-b092-4977-9bd8-b39a90179646', nama_mapel: 'PJOK - Pendidikan Jasmani, Olahraga, dan Kesehatan', jenjang: 'SD/MI' },
        { id: '87120966-4de6-49a4-a824-29852ef640b9', nama_mapel: 'IPS - Ilmu Pengetahuan Sosial', jenjang: 'SD/MI' },
        { id: 'a00d7e61-79fc-4137-9f95-525f233630cb', nama_mapel: 'Pendidikan Agama Islam', jenjang: 'SD/MI' },
        { id: 'a6d25e8c-8ca4-487e-989e-a151927fd66e', nama_mapel: 'Seni Budaya', jenjang: 'SD/MI' },
        { id: 'a8684e5d-cf98-4c8e-86f1-b44e1e837d8e', nama_mapel: 'IPA - Ilmu Pengetahuan Alam', jenjang: 'SD/MI' },
        { id: 'bfac324f-ed48-4cb1-a3eb-6d3e2bebb927', nama_mapel: 'Bahasa Sunda', jenjang: 'SD/MI' },
        { id: 'da76240b-18fb-4865-981c-0a2d25d24859', nama_mapel: 'Bahasa Indonesia', jenjang: 'SD/MI' },
        { id: 'faff1cd0-da3f-4a23-b614-a6f7437a51e6', nama_mapel: 'Pendidikan Pancasila', jenjang: 'SD/MI' }
                ];
                
                // Populate with fallback data
                document.querySelectorAll('.mapel-select').forEach(select => {
                    populateMapelDropdown(select);
                });
            }
        }

        function populateKelasDropdown(selectElement) {
            // Clear existing options except the first one
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            // Add new options
            kelasData.forEach(kelas => {
                const option = document.createElement('option');
                option.value = kelas.id;
                option.textContent = `${kelas.nama_kelas} (Tahun Ajar: ${kelas.tahun_ajaran})`;
                selectElement.appendChild(option);
            });
        }

        function populateMapelDropdown(selectElement) {
            // Clear existing options except the first one
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            // Add new options
            mapelData.forEach(mapel => {
                const option = document.createElement('option');
                option.value = mapel.id;
                option.textContent = `${mapel.nama_mapel} (${mapel.jenjang})`;
                selectElement.appendChild(option);
            });
        }

        // ====================
        // DYNAMIC FIELDS
        // ====================
        function addKelasSelect(container, type) {
            const index = container.querySelectorAll('.input-group').length + 1;

            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `
                <label>Kelas ${index} <span class="${type === 'umum' ? 'required' : 'optional'}">${type === 'umum' ? '(wajib)' : '(opsional)'}</span></label>
                <select class="${type}-kelas-select" ${type === 'umum' ? 'required' : ''}>
                    <option value="">Pilih Kelas</option>
                </select>
                ${type === 'umum' && index > 1 ? `<button type="button" class="remove-btn remove-umum-kelas" style="margin-top: 10px;">
                    <i class="fas fa-minus"></i> Hapus Kelas
                </button>` : ''}
            `;

            container.appendChild(div);

            // Populate the new dropdown
            const select = div.querySelector('select');
            populateKelasDropdown(select);

            // Add event listener for remove button
            if (type === 'umum' && index > 1) {
                const removeBtn = div.querySelector('.remove-umum-kelas');
                removeBtn.addEventListener('click', function() {
                    div.remove();
                    updateKelasLabels(container);
                });
            }
        }

        function updateKelasLabels(container) {
            const groups = container.querySelectorAll('.input-group');
            groups.forEach((group, index) => {
                const label = group.querySelector('label');
                label.innerHTML = `Kelas ${index + 1} <span class="required">(wajib)</span>`;
            });
        }

        function addMapelField() {
            const mapelCount = mapelContainer.querySelectorAll('.mapel-container').length + 1;

            const mapelDiv = document.createElement('div');
            mapelDiv.className = 'mapel-container';
            mapelDiv.innerHTML = `
                <div class="mapel-header">
                    <h5>Mata Pelajaran ${mapelCount}</h5>
                    <button type="button" class="remove-btn remove-mapel">
                        <i class="fas fa-trash"></i> Hapus
                    </button>
                </div>
                <div class="input-group">
                    <select class="mapel-select" required>
                        <option value="">Pilih Mata Pelajaran</option>
                    </select>
                </div>
                <div class="kelas-list">
                    <div class="kelas-item">
                        <select class="kelas-select" required>
                            <option value="">Pilih Kelas</option>
                        </select>
                        <button type="button" class="remove-btn remove-kelas">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <button type="button" class="add-btn add-kelas">
                    <i class="fas fa-plus"></i> Tambah Kelas
                </button>
            `;

            mapelContainer.appendChild(mapelDiv);

            // Populate dropdowns
            const mapelSelect = mapelDiv.querySelector('.mapel-select');
            const kelasSelect = mapelDiv.querySelector('.kelas-select');
            populateMapelDropdown(mapelSelect);
            populateKelasDropdown(kelasSelect);

            // Add event listeners
            const removeMapelBtn = mapelDiv.querySelector('.remove-mapel');
            removeMapelBtn.addEventListener('click', function() {
                if (mapelContainer.querySelectorAll('.mapel-container').length > 1) {
                    mapelDiv.remove();
                    updateMapelLabels();
                }
            });

            const addKelasBtn = mapelDiv.querySelector('.add-kelas');
            addKelasBtn.addEventListener('click', function() {
                addKelasToMapel(mapelDiv);
            });

            const removeKelasBtn = mapelDiv.querySelector('.remove-kelas');
            removeKelasBtn.addEventListener('click', function() {
                const kelasItem = this.closest('.kelas-item');
                if (mapelDiv.querySelectorAll('.kelas-item').length > 1) {
                    kelasItem.remove();
                }
            });
        }

        function addKelasToMapel(mapelDiv) {
            const kelasList = mapelDiv.querySelector('.kelas-list');

            const kelasItem = document.createElement('div');
            kelasItem.className = 'kelas-item';
            kelasItem.innerHTML = `
                <select class="kelas-select" required>
                    <option value="">Pilih Kelas</option>
                </select>
                <button type="button" class="remove-btn remove-kelas">
                    <i class="fas fa-minus"></i>
                </button>
            `;

            kelasList.appendChild(kelasItem);

            // Populate dropdown
            const select = kelasItem.querySelector('.kelas-select');
            populateKelasDropdown(select);

            // Add event listener for remove button
            const removeBtn = kelasItem.querySelector('.remove-kelas');
            removeBtn.addEventListener('click', function() {
                if (kelasList.querySelectorAll('.kelas-item').length > 1) {
                    kelasItem.remove();
                }
            });
        }

        function updateMapelLabels() {
            const mapels = mapelContainer.querySelectorAll('.mapel-container');
            mapels.forEach((mapel, index) => {
                const title = mapel.querySelector('h5');
                title.textContent = `Mata Pelajaran ${index + 1}`;
            });
        }

        // ====================
        // PHOTO HANDLING
        // ====================
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.match('image.*')) {
                showStatus('error', 'File harus berupa gambar (JPG, PNG, GIF)');
                return;
            }

            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showStatus('error', 'Ukuran file maksimal 5MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                photoDataUrl = e.target.result;
                updatePhotoPreview(photoDataUrl);
            };
            reader.readAsDataURL(file);
        }

        async function openCamera() {
            cameraModal.style.display = 'flex';

            try {
                const constraints = {
                    video: { 
                        facingMode: cameraFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraPreview.srcObject = stream;
            } catch (error) {
                console.error('Camera access error:', error);
                showStatus('error', 'Tidak dapat mengakses kamera. Pastikan izin kamera telah diberikan.');
                closeCameraModal();
            }
        }

        function closeCameraModal() {
            cameraModal.style.display = 'none';

            // Stop camera stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function switchCamera() {
            cameraFacingMode = cameraFacingMode === 'user' ? 'environment' : 'user';
            
            // Restart camera with new facing mode
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            openCamera();
        }

        function capturePhoto() {
            const canvas = document.createElement('canvas');
            canvas.width = cameraPreview.videoWidth;
            canvas.height = cameraPreview.videoHeight;

            const context = canvas.getContext('2d');
            
            // Flip horizontally for selfie
            if (cameraFacingMode === 'user') {
                context.translate(canvas.width, 0);
                context.scale(-1, 1);
            }
            
            context.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);

            photoDataUrl = canvas.toDataURL('image/jpeg', 0.8);
            updatePhotoPreview(photoDataUrl);

            closeCameraModal();
        }

        function updatePhotoPreview(dataUrl) {
            photoPreview.innerHTML = '';
            const img = document.createElement('img');
            img.src = dataUrl;
            photoPreview.appendChild(img);
        }

        // ====================
        // AUTHENTICATION
        // ====================
        async function handleLogin() {
            if (isLoading) return;
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            // Validation
            if (!email || !password) {
                showStatus('error', 'Email dan password harus diisi');
                return;
            }

            if (!validateEmail(email)) {
                showStatus('error', 'Format email tidak valid');
                return;
            }

            isLoading = true;
            loginBtn.disabled = true;
            showStatus('loading', 'Memproses login...');

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                // Get user profile
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('tipe_akun, nama_lengkap')
                    .eq('id', data.user.id)
                    .single();

                if (profileError) throw profileError;

                showStatus('success', `Login berhasil! Selamat datang, ${profile.nama_lengkap}.`);

                // Animate progress bar
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    progressBar.style.width = `${progress}%`;

                    if (progress >= 100) {
                        clearInterval(interval);
                        redirectToDashboard(profile.tipe_akun);
                    }
                }, 100);

            } catch (error) {
                console.error('Login error:', error);
                showStatus('error', 'Login gagal: ' + getErrorMessage(error));
            } finally {
                isLoading = false;
                loginBtn.disabled = false;
            }
        }

        async function handleSignup() {
            if (isLoading) return;
            
            // Validate terms agreement
            if (!termsAgreement.checked) {
                showStatus('error', 'Anda harus menyetujui Syarat & Ketentuan');
                return;
            }

            // Get form data
            const nama = document.getElementById('signup-nama').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            const whatsapp = document.getElementById('signup-whatsapp').value.trim();
            const tipeAkun = currentAccountType;

            // Validation
            if (!nama || !email || !password || !confirmPassword) {
                showStatus('error', 'Semua field wajib harus diisi');
                return;
            }

            if (!validateEmail(email)) {
                showStatus('error', 'Format email tidak valid');
                return;
            }

            if (password !== confirmPassword) {
                showStatus('error', 'Password dan konfirmasi password tidak sama');
                return;
            }

            if (password.length < 8) {
                showStatus('error', 'Password minimal 8 karakter');
                return;
            }

            if (whatsapp && !validatePhone(whatsapp)) {
                showStatus('error', 'Format nomor WhatsApp tidak valid');
                return;
            }

            // Additional validation based on account type
            if (tipeAkun === 'siswa') {
                const kelasId = document.getElementById('siswa-kelas').value;
                if (!kelasId) {
                    showStatus('error', 'Kelas wajib dipilih untuk siswa');
                    return;
                }
            } else if (tipeAkun === 'guru') {
                if (currentGuruRole === 'umum') {
                    const kelasSelects = document.querySelectorAll('.umum-kelas-select');
                    const hasSelection = Array.from(kelasSelects).some(select => select.value);
                    if (!hasSelection) {
                        showStatus('error', 'Minimal pilih satu kelas untuk guru umum');
                        return;
                    }
                } else if (currentGuruRole === 'wali') {
                    const kelasId = document.getElementById('wali-kelas').value;
                    if (!kelasId) {
                        showStatus('error', 'Kelas wajib dipilih untuk wali kelas');
                        return;
                    }
                } else if (currentGuruRole === 'mapel') {
                    const mapelContainers = document.querySelectorAll('.mapel-container');
                    let isValid = true;
                    mapelContainers.forEach(container => {
                        const mapelSelect = container.querySelector('.mapel-select');
                        const kelasSelects = container.querySelectorAll('.kelas-select');
                        if (!mapelSelect.value || Array.from(kelasSelects).every(select => !select.value)) {
                            isValid = false;
                        }
                    });
                    if (!isValid) {
                        showStatus('error', 'Setiap mata pelajaran harus memiliki minimal satu kelas');
                        return;
                    }
                }
            } else if (tipeAkun === 'admin') {
                const jabatan = document.getElementById('admin-jabatan').value;
                if (!jabatan) {
                    showStatus('error', 'Jabatan wajib dipilih untuk admin');
                    return;
                }
            }

            isLoading = true;
            signupBtn.disabled = true;
            showStatus('loading', 'Mendaftarkan akun...');

            try {
                // 1. Sign up user with Supabase Auth
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            nama_lengkap: nama,
                            tipe_akun: tipeAkun
                        }
                    }
                });

                if (authError) throw authError;

                // 2. Create profile in profiles table
                const profileData = {
                    id: authData.user.id,
                    email: email,
                    nama_lengkap: nama,
                    tipe_akun: tipeAkun,
                    no_whatsapp: whatsapp || null,
                    foto_profil: photoDataUrl || null,
                    created_at: new Date().toISOString()
                };

                const { error: profileError } = await supabaseClient
                    .from('profiles')
                    .insert([profileData]);

                if (profileError) throw profileError;

                // 3. Create account type specific data
                if (tipeAkun === 'siswa') {
                    await createSiswaData(authData.user.id);
                } else if (tipeAkun === 'guru') {
                    await createGuruData(authData.user.id);
                } else if (tipeAkun === 'admin') {
                    await createAdminData(authData.user.id);
                }

                showStatus('success', 'Pendaftaran berhasil! Silakan cek email Anda untuk verifikasi.');

                // Animate progress bar
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    progressBar.style.width = `${progress}%`;

                    if (progress >= 100) {
                        clearInterval(interval);
                        
                        // Auto login after successful signup
                        setTimeout(async () => {
                            const { error: loginError } = await supabaseClient.auth.signInWithPassword({
                                email: email,
                                password: password
                            });

                            if (!loginError) {
                                showStatus('success', 'Login otomatis berhasil! Mengalihkan...');
                                setTimeout(() => {
                                    switchForm('login');
                                    resetSignupForm();
                                }, 1500);
                            }
                        }, 1000);
                    }
                }, 200);

            } catch (error) {
                console.error('Signup error:', error);
                showStatus('error', 'Pendaftaran gagal: ' + getErrorMessage(error));
            } finally {
                isLoading = false;
                signupBtn.disabled = false;
            }
        }

        async function createSiswaData(userId) {
            const kelasId = document.getElementById('siswa-kelas').value;
            const nis = document.getElementById('siswa-nis').value.trim();
            const nisn = document.getElementById('siswa-nisn').value.trim();
            const alamat = document.getElementById('siswa-alamat').value.trim();
            const ortu = document.getElementById('siswa-ortu').value.trim();

            const siswaData = {
                user_id: userId,
                kelas_id: kelasId,
                nis: nis || null,
                nisn: nisn || null,
                alamat: alamat || null,
                nama_ortu: ortu || null,
                status: 'aktif'
            };

            const { error } = await supabaseClient
                .from('siswa')
                .insert([siswaData]);

            if (error) throw error;
        }

        async function createGuruData(userId) {
            const nip = document.getElementById('guru-nip').value.trim();
            const nuptk = document.getElementById('guru-nuptk').value.trim();
            const alamat = document.getElementById('guru-alamat').value.trim();

            const guruData = {
                user_id: userId,
                nip: nip || null,
                nuptk: nuptk || null,
                alamat: alamat || null,
                role_guru: currentGuruRole,
                status: 'aktif'
            };

            const { data: guruInsert, error: guruError } = await supabaseClient
                .from('guru')
                .insert([guruData])
                .select()
                .single();

            if (guruError) throw guruError;

            // Create role-specific data
            if (currentGuruRole === 'umum') {
                const kelasSelects = document.querySelectorAll('.umum-kelas-select');
                const kelasData = Array.from(kelasSelects)
                    .filter(select => select.value)
                    .map(select => ({
                        guru_id: guruInsert.id,
                        kelas_id: select.value
                    }));

                if (kelasData.length > 0) {
                    const { error } = await supabaseClient
                        .from('guru_kelas')
                        .insert(kelasData);

                    if (error) throw error;
                }
            } else if (currentGuruRole === 'wali') {
                const kelasId = document.getElementById('wali-kelas').value;
                
                const { error } = await supabaseClient
                    .from('wali_kelas')
                    .insert([{
                        guru_id: guruInsert.id,
                        kelas_id: kelasId,
                        tahun_ajaran: new Date().getFullYear()
                    }]);

                if (error) throw error;
            } else if (currentGuruRole === 'mapel') {
                const mapelContainers = document.querySelectorAll('.mapel-container');
                
                for (const container of mapelContainers) {
                    const mapelId = container.querySelector('.mapel-select').value;
                    const kelasSelects = container.querySelectorAll('.kelas-select');
                    const kelasIds = Array.from(kelasSelects)
                        .filter(select => select.value)
                        .map(select => select.value);

                    if (mapelId && kelasIds.length > 0) {
                        const guruMapelData = kelasIds.map(kelasId => ({
                            guru_id: guruInsert.id,
                            mapel_id: mapelId,
                            kelas_id: kelasId
                        }));

                        const { error } = await supabaseClient
                            .from('guru_mapel')
                            .insert(guruMapelData);

                        if (error) throw error;
                    }
                }
            }
        }

        async function createAdminData(userId) {
            const jabatan = document.getElementById('admin-jabatan').value;
            const departemen = document.getElementById('admin-departemen').value.trim();

            const adminData = {
                user_id: userId,
                jabatan: jabatan,
                departemen: departemen || null,
                status: 'aktif'
            };

            const { error } = await supabaseClient
                .from('admin')
                .insert([adminData]);

            if (error) throw error;
        }

        async function handleSocialLogin(provider) {
            if (isLoading) return;
            
            isLoading = true;
            showStatus('loading', `Mengarahkan ke ${provider}...`);

            try {
                const { error } = await supabaseClient.auth.signInWithOAuth({
                    provider: provider,
                    options: {
                        redirectTo: `${window.location.origin}/auth/callback`
                    }
                });

                if (error) throw error;
            } catch (error) {
                console.error('Social login error:', error);
                showStatus('error', 'Login dengan ' + provider + ' gagal');
                isLoading = false;
            }
        }

        async function handleResetPassword() {
            const email = document.getElementById('reset-email').value.trim();

            if (!email || !validateEmail(email)) {
                showStatus('error', 'Masukkan email yang valid');
                return;
            }

            resetPasswordBtn.disabled = true;
            showStatus('loading', 'Mengirim link reset password...');

            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: `${window.location.origin}/reset-password`,
                });

                if (error) throw error;

                showStatus('success', 'Link reset password telah dikirim ke email Anda. Silakan cek inbox Anda.');
                
                setTimeout(() => {
                    switchForm('login');
                }, 3000);

            } catch (error) {
                console.error('Reset password error:', error);
                showStatus('error', 'Gagal mengirim link reset password: ' + getErrorMessage(error));
            } finally {
                resetPasswordBtn.disabled = false;
            }
        }

        // ====================
        // UTILITY FUNCTIONS
        // ====================
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePhone(phone) {
            const re = /^[0-9]{10,13}$/;
            return re.test(phone);
        }

        function getErrorMessage(error) {
            if (error.message.includes('Invalid login credentials')) {
                return 'Email atau password salah';
            } else if (error.message.includes('Email not confirmed')) {
                return 'Email belum dikonfirmasi. Silakan cek email Anda';
            } else if (error.message.includes('User already registered')) {
                return 'Email sudah terdaftar';
            } else if (error.message.includes('Password should be at least')) {
                return 'Password minimal 6 karakter';
            } else if (error.message.includes('rate limit')) {
                return 'Terlalu banyak percobaan. Silakan coba lagi nanti';
            }
            return error.message;
        }

        function redirectToDashboard(tipeAkun) {
            const dashboards = {
                'admin': '/dashboard/admin',
                'guru': '/dashboard/guru',
                'siswa': '/dashboard/siswa'
            };
            
            const dashboardUrl = dashboards[tipeAkun] || '/dashboard';
            
            // In production, uncomment this line:
            // window.location.href = dashboardUrl;
            
            // For demo purposes, show a message
            showStatus('success', `Redirect ke: ${dashboardUrl}`);
            console.log(`Redirecting to: ${dashboardUrl}`);
        }

        function resetSignupForm() {
            // Reset form fields
            document.getElementById('signup-form').reset();
            
            // Reset photo
            photoDataUrl = null;
            photoPreview.innerHTML = '<i class="fas fa-user" style="font-size: 3.5rem; color: var(--gray);"></i>';
            
            // Reset dynamic fields
            resetDynamicFields();
            
            // Reset validation displays
            passwordStrength.style.display = 'none';
            passwordMatch.style.display = 'none';
            
            // Reset account type to default
            accountTypeBtns.forEach(btn => {
                if (btn.dataset.type === 'guru') {
                    btn.classList.add('active');
                    currentAccountType = 'guru';
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Show guru fields by default
            updateAccountTypeFields();
            
            // Reset terms agreement
            termsAgreement.checked = false;
            updateSignupButtonState();
        }

        function resetDynamicFields() {
            // Reset guru umum fields
            umumKelasContainer.innerHTML = '';
            addKelasSelect(umumKelasContainer, 'umum');
            
            // Reset mapel fields
            mapelContainer.innerHTML = '';
            addMapelField();
            
            // Reset role to default
            guruRoleBtns.forEach(btn => {
                if (btn.dataset.role === 'umum') {
                    btn.classList.add('active');
                    currentGuruRole = 'umum';
                } else {
                    btn.classList.remove('active');
                }
            });
            
            updateGuruRoleFields();
        }

        function showStatus(type, message) {
            // Set status type
            statusContainer.className = 'status-container';
            statusContainer.classList.add(type);
            
            // Set icon based on type
            let icon = 'fas fa-info-circle';
            let title = 'Informasi';
            
            switch(type) {
                case 'success':
                    icon = 'fas fa-check-circle';
                    title = 'Berhasil';
                    break;
                case 'error':
                    icon = 'fas fa-exclamation-circle';
                    title = 'Error';
                    break;
                case 'loading':
                    icon = 'fas fa-spinner fa-spin';
                    title = 'Memproses';
                    break;
            }
            
            statusIcon.className = icon;
            statusTitle.textContent = title;
            statusMessage.textContent = message;
            
            // Show container
            statusContainer.style.display = 'block';
            
            // Reset progress bar
            progressBar.style.width = '0%';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    if (statusContainer.classList.contains('success')) {
                        hideStatus();
                    }
                }, 5000);
            }
        }

        function hideStatus() {
            statusContainer.style.display = 'none';
        }
    </script>
</body>
</html>
