<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verifikasi Login | Auth System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --admin: #7209b7;
      --guru: #f72585;
      --siswa: #4cc9f0;
      --dark: #2b2d42;
      --light: #f8f9fa;
      --gray: #8d99ae;
      --border-radius: 12px;
      --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      color: var(--dark);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      line-height: 1.6;
    }

    .auth-container {
      width: 100%;
      max-width: 520px;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      transition: var(--transition);
    }

    .auth-header {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .auth-header::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 20px 20px;
      opacity: 0.3;
      animation: float 20s linear infinite;
    }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 15px;
      position: relative;
      z-index: 2;
    }

    .logo-icon {
      font-size: 28px;
      background: rgba(255, 255, 255, 0.2);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .logo-text {
      font-family: 'Poppins', sans-serif;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .auth-header h1 {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 22px;
      margin-bottom: 8px;
      position: relative;
      z-index: 2;
    }

    .auth-header p {
      opacity: 0.9;
      font-size: 15px;
      position: relative;
      z-index: 2;
    }

    .auth-content {
      padding: 40px 35px;
      text-align: center;
    }

    .loading-section {
      margin-bottom: 35px;
    }

    .loading-text {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 25px;
      color: var(--dark);
    }

    .loader {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto 30px;
      position: relative;
      width: 100px;
      height: 100px;
    }

    .loader-circle {
      position: absolute;
      border-radius: 50%;
      border: 5px solid transparent;
      animation: spin 1.5s linear infinite;
    }

    .loader-circle-1 {
      width: 100%;
      height: 100%;
      border-top: 5px solid var(--primary);
      border-right: 5px solid var(--primary);
    }

    .loader-circle-2 {
      width: 70%;
      height: 70%;
      border-top: 5px solid var(--primary-light);
      border-right: 5px solid var(--primary-light);
      animation-direction: reverse;
      animation-duration: 1.2s;
    }

    .loader-circle-3 {
      width: 40%;
      height: 40%;
      border-top: 5px solid var(--success);
      border-right: 5px solid var(--success);
      animation-duration: 0.9s;
    }

    .loader-center {
      width: 20px;
      height: 20px;
      background-color: var(--primary);
      border-radius: 50%;
      z-index: 3;
    }

    .progress-text {
      font-size: 14px;
      color: var(--gray);
      margin-top: 10px;
      font-weight: 500;
    }

    .status-message {
      background-color: #f0f7ff;
      border-left: 4px solid var(--primary);
      padding: 16px;
      border-radius: 8px;
      margin-top: 25px;
      text-align: left;
      display: none;
    }

    .status-message.show {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    .status-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-detail {
      font-size: 14px;
      color: var(--gray);
    }

    .user-info {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
      display: none;
    }

    .user-info.show {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    .user-info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .user-info-label {
      color: var(--gray);
      font-weight: 500;
    }

    .user-info-value {
      color: var(--dark);
      font-weight: 600;
    }

    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .role-admin {
      background-color: rgba(114, 9, 183, 0.1);
      color: var(--admin);
    }

    .role-guru {
      background-color: rgba(247, 37, 133, 0.1);
      color: var(--guru);
    }

    .role-siswa {
      background-color: rgba(76, 201, 240, 0.1);
      color: var(--siswa);
    }

    .auth-footer {
      margin-top: 30px;
      padding-top: 25px;
      border-top: 1px solid #eee;
      font-size: 14px;
      color: var(--gray);
    }

    .auth-footer a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
    }

    .auth-footer a:hover {
      color: var(--secondary);
      text-decoration: underline;
    }

    .error-message {
      background-color: #fff5f5;
      border-left: 4px solid #ff6b6b;
      color: #cc4e4e;
    }

    .error-message .status-title {
      color: #ff6b6b;
    }

    .success-message {
      background-color: #f0fff4;
      border-left: 4px solid #38b000;
      color: #2e7d32;
    }

    .success-message .status-title {
      color: #38b000;
    }

    .redirect-countdown {
      font-weight: 600;
      color: var(--primary);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes float {
      0% { transform: translate(0, 0) rotate(0deg); }
      100% { transform: translate(-10px, -10px) rotate(360deg); }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @media (max-width: 576px) {
      .auth-container {
        max-width: 100%;
      }
      
      .auth-header {
        padding: 25px 20px;
      }
      
      .auth-content {
        padding: 30px 20px;
      }
      
      .logo-text {
        font-size: 20px;
      }
      
      .auth-header h1 {
        font-size: 20px;
      }
      
      .loading-text {
        font-size: 16px;
      }
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --dark: #f8f9fa;
        --light: #1a1d28;
        --gray: #a0aec0;
      }
      
      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      }
      
      .auth-container {
        background-color: #222831;
        color: var(--dark);
      }
      
      .auth-footer {
        border-top-color: #333;
      }
      
      .status-message {
        background-color: #2d3748;
      }
      
      .user-info {
        background-color: #2d3748;
      }
      
      .error-message {
        background-color: #422626;
      }
      
      .success-message {
        background-color: #1e3a2c;
      }
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-header">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div class="logo-text">Sistem Akademik</div>
      </div>
      <h1>Verifikasi Login</h1>
      <p>Kami sedang memproses autentikasi Anda</p>
    </div>
    
    <div class="auth-content">
      <div class="loading-section">
        <div class="loading-text" id="loading-text">Memverifikasi sesi login...</div>
        
        <div class="loader">
          <div class="loader-circle loader-circle-1"></div>
          <div class="loader-circle loader-circle-2"></div>
          <div class="loader-circle loader-circle-3"></div>
          <div class="loader-center"></div>
        </div>
        
        <div class="progress-text" id="progress-text">Mengambil data sesi...</div>
      </div>
      
      <div class="status-message" id="status-message">
        <div class="status-title">
          <i class="fas fa-info-circle"></i>
          <span id="status-title">Memproses</span>
        </div>
        <div class="status-detail" id="status-detail">
          Tunggu sebentar saat kami memverifikasi kredensial Anda.
        </div>
      </div>
      
      <div class="user-info" id="user-info">
        <div class="user-info-item">
          <span class="user-info-label">Email:</span>
          <span class="user-info-value" id="user-email">-</span>
        </div>
        <div class="user-info-item">
          <span class="user-info-label">Tipe Akun:</span>
          <span class="user-info-value" id="user-role">-</span>
        </div>
        <div class="user-info-item">
          <span class="user-info-label">Dashboard:</span>
          <span class="user-info-value" id="user-dashboard">-</span>
        </div>
      </div>
      
      <div class="auth-footer">
        <p>Jika halaman ini tidak redirect otomatis dalam 10 detik, <a href="#" id="manual-redirect">klik di sini</a>.</p>
        <p style="margin-top: 8px; font-size: 13px;">Â© 2023 Sistem Akademik. All rights reserved.</p>
      </div>
    </div>
  </div>

  <script>
    // Supabase configuration - GANTI dengan credential Anda
    const SUPABASE_URL = 'https://lgsufwalckbbdlhyqchp.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_On-J7LB2g9ND4zXtZA7IbA_KMmP-rsZ';

    // Redirect mapping berdasarkan tipe akun
    const REDIRECT_MAP = {
      admin: '../../dashboard/admin/',
      guru: '../../dashboard/guru/',
      siswa: '../../dashboard/siswa/',
    };

    // Role labels untuk tampilan
    const ROLE_LABELS = {
      admin: { label: 'Administrator', class: 'role-admin', icon: 'fas fa-crown' },
      guru: { label: 'Guru/Pengajar', class: 'role-guru', icon: 'fas fa-chalkboard-teacher' },
      siswa: { label: 'Siswa', class: 'role-siswa', icon: 'fas fa-user-graduate' }
    };

    // DOM Elements
    const loadingText = document.getElementById('loading-text');
    const progressText = document.getElementById('progress-text');
    const statusMessage = document.getElementById('status-message');
    const statusTitle = document.getElementById('status-title');
    const statusDetail = document.getElementById('status-detail');
    const userInfo = document.getElementById('user-info');
    const userEmail = document.getElementById('user-email');
    const userRole = document.getElementById('user-role');
    const userDashboard = document.getElementById('user-dashboard');
    const manualRedirect = document.getElementById('manual-redirect');
    
    // Status steps untuk animasi
    const statusSteps = [
      "Mengambil data sesi...",
      "Memverifikasi token...",
      "Mengecek kredensial...",
      "Mengambil profil pengguna...",
      "Mengidentifikasi tipe akun...",
      "Menyiapkan dashboard..."
    ];
    
    let currentStep = 0;
    let stepInterval;
    let finalRedirectUrl = '../../';

    // Initialize Supabase client dengan nama yang sesuai
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Fungsi untuk update status UI
    function updateStatus(title, detail, type = "info") {
      statusTitle.textContent = title;
      statusDetail.textContent = detail;
      
      // Reset class
      statusMessage.className = "status-message";
      
      // Add appropriate class based on type
      if (type === "error") {
        statusMessage.classList.add("error-message");
      } else if (type === "success") {
        statusMessage.classList.add("success-message");
      }
      
      // Show the message
      statusMessage.classList.add("show");
    }
    
    // Fungsi untuk menampilkan info pengguna
    function showUserInfo(email, roleType, dashboardUrl) {
      const roleInfo = ROLE_LABELS[roleType] || { label: roleType, class: '', icon: 'fas fa-user' };
      
      userEmail.textContent = email || '-';
      userRole.innerHTML = `${roleInfo.label} <span class="role-badge ${roleInfo.class}"><i class="${roleInfo.icon}"></i> ${roleType}</span>`;
      userDashboard.textContent = dashboardUrl.replace('../../', '') || '-';
      
      userInfo.classList.add('show');
    }
    
    // Fungsi untuk animasi progress text
    function animateProgressText() {
      stepInterval = setInterval(() => {
        progressText.textContent = statusSteps[currentStep];
        currentStep = (currentStep + 1) % statusSteps.length;
      }, 1500);
    }
    
    // Fungsi untuk redirect dengan countdown
    function redirectWithCountdown(url, seconds = 3, roleType = '') {
      clearInterval(stepInterval);
      
      let countdown = seconds;
      const roleLabel = ROLE_LABELS[roleType]?.label || roleType;
      loadingText.textContent = roleType ? `Login sebagai ${roleLabel} berhasil!` : 'Login berhasil!';
      
      progressText.innerHTML = `Mengarahkan ke dashboard <span class="redirect-countdown">${roleLabel}</span> dalam <span class="redirect-countdown">${countdown}</span> detik...`;
      
      const countdownInterval = setInterval(() => {
        countdown--;
        progressText.innerHTML = `Mengarahkan ke dashboard <span class="redirect-countdown">${roleLabel}</span> dalam <span class="redirect-countdown">${countdown}</span> detik...`;
        
        if (countdown <= 0) {
          clearInterval(countdownInterval);
          window.location.href = url;
        }
      }, 1000);
    }
    
    // Fungsi utama untuk menangani autentikasi
    async function handleAuth() {
      // Mulai animasi progress text
      animateProgressText();
      
      try {
        // Langkah 0: Exchange code for session (untuk OAuth)
        updateStatus("Memproses", "Memproses kode otorisasi...", "info");
        try {
          await supabaseClient.auth.exchangeCodeForSession(window.location.href);
        } catch (exchangeError) {
          // Ini normal jika tidak ada code di URL (untuk login email/password)
          console.log("Exchange code tidak diperlukan:", exchangeError.message);
        }

        // Langkah 1: Mengambil sesi dan user
        updateStatus("Memproses", "Mengecek status autentikasi Anda...", "info");
        
        const { data: sessionData } = await supabaseClient.auth.getSession();
        const user = sessionData?.session?.user;

        if (!user) {
          updateStatus("Autentikasi Gagal", "Tidak ada sesi login yang aktif. Silakan login kembali.", "error");
          progressText.textContent = "Mengarahkan ke halaman login...";
          setTimeout(() => {
            window.location.href = '../../';
          }, 3000);
          return;
        }

        // Langkah 2: Mengambil profil pengguna dari tabel profiles
        updateStatus("Memproses", "Mengambil data profil pengguna...", "info");
        progressText.textContent = "Mengambil data profil...";

        const { data: profile, error } = await supabaseClient
          .from('profiles')
          .select('tipe_akun')
          .eq('id', user.id)
          .single();

        if (error || !profile) {
          console.error(error);
          updateStatus("Kesalahan", "Gagal mengambil data profil. Silakan coba lagi.", "error");
          progressText.textContent = "Mengarahkan ke halaman login...";
          setTimeout(() => {
            window.location.href = '../../';
          }, 3000);
          return;
        }

        // Login sukses dan profil ditemukan
        updateStatus("Login Berhasil", "Autentikasi berhasil diverifikasi. Mengidentifikasi tipe akun...", "success");
        
        // Tentukan redirect berdasarkan tipe_akun
        const redirectUrl = REDIRECT_MAP[profile.tipe_akun] ?? '../../';
        finalRedirectUrl = redirectUrl;
        
        // Tampilkan info pengguna
        showUserInfo(user.email, profile.tipe_akun, redirectUrl);
        
        // Redirect dengan countdown
        redirectWithCountdown(redirectUrl, 3, profile.tipe_akun);
        
      } catch (err) {
        // Tangani error yang tidak terduga
        console.error("Unexpected error:", err);
        clearInterval(stepInterval);
        
        updateStatus("Kesalahan Sistem", "Terjadi kesalahan tak terduga. Silakan coba lagi.", "error");
        progressText.textContent = "Mengarahkan ke halaman login...";
        
        // Redirect ke halaman login setelah 5 detik
        setTimeout(() => {
          window.location.href = '../../';
        }, 5000);
      }
    }
    
    // Setup manual redirect link dengan finalRedirectUrl
    manualRedirect.addEventListener('click', e => {
      e.preventDefault();
      window.location.href = finalRedirectUrl;
    });
    
    // Mulai proses autentikasi ketika halaman dimuat
    document.addEventListener('DOMContentLoaded', function() {
      // Tambahkan sedikit delay untuk efek visual
      setTimeout(() => {
        handleAuth();
      }, 800);
    });
    
    // Tambahkan efek hover pada container
    const authContainer = document.querySelector('.auth-container');
    authContainer.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-5px)';
      this.style.boxShadow = '0 15px 40px rgba(0, 0, 0, 0.12)';
    });
    
    authContainer.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = 'var(--box-shadow)';
    });
  </script>
</body>
</html>
